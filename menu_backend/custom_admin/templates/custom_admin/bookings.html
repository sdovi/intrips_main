{% extends 'custom_admin/base.html' %}
{% block content %}
<h2>üìÖ –°–ø–∏—Å–æ–∫ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π</h2>

<a href="{% url 'archive_list' %}" class="btn btn-secondary mb-3">üìÇ –ü–µ—Ä–µ–π—Ç–∏ –≤ –∞—Ä—Ö–∏–≤</a>

<!-- –¢–∞–±–ª–∏—Ü–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π -->
<table class="table custom-table">
    <thead>
        <tr>
            <th>–£—Å–ª—É–≥–∞</th>
            <th>–ö–æ–º–Ω–∞—Ç–∞</th>
            <th>–ì–æ—Å—Ç–∏</th>
            <th>–î–∞—Ç–∞</th>
            <th>–í—Ä–µ–º—è</th>
            <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
            <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–û–±—â–∞—è —Å—É–º–º–∞</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
    </thead>
    <tbody>
        {% for booking in bookings %}
        <tr class="table-row">
            <td class="service-column">
                <img src="/static/img/img_in_work.png" alt="Service Icon" class="service-icon">
                {{ booking.service_name }}
            </td>
            <td>{{ booking.room_number }}</td>
            <td>{{ booking.guest_count }}</td>
            <td>{{ booking.date }}</td>
            <td>{{ booking.start_time }} - {{ booking.end_time|default:"--:--" }}</td>
            <td>{{ booking.employee.full_name }}</td>
            <td>{{ booking.comment|default:"-" }}</td>
            <td>
                <span class="badge 
                    {% if booking.status.name == '–í—ã–ø–æ–ª–Ω–µ–Ω–æ' %}bg-success
                    {% elif booking.status.name == '–í —Ä–∞–±–æ—Ç–µ' %}bg-warning
                    {% elif booking.status.name == '–û—Ç–º–µ–Ω–∞' %}bg-danger
                    {% else %}bg-secondary
                    {% endif %}">
                    {{ booking.status.name }}
                </span>
            </td>
            <td class="text-end"><strong>{{ booking.total_price }} ‚ÇΩ</strong></td>
            <td>
                <div class="dropdown">
                    <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton{{ booking.id }}" data-bs-toggle="dropdown" aria-expanded="false">
                        –ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton{{ booking.id }}">
                        {% for status in statuses %}
                        <li>
                            <a class="dropdown-item" href="#" onclick="updateStatus({{ booking.id }}, {{ status.id }})">
                                {{ status.name }}
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ -->
<style>
    th, td {
        padding: 14px 18px;
        text-align: left;
    }

    .table-row {
        border-bottom: 1px solid #ddd;
    }

    /* –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –∏–∫–æ–Ω–∫–∏ —Å —Ç–µ–∫—Å—Ç–æ–º */
    .service-column {
        display: flex;
        align-items: center;
    }

    /* –£–¥–∞–ª–µ–Ω–∏–µ —Ä–∞–º–æ–∫ –∏ —Å—Ç–∏–ª–∏–∑–∞—Ü–∏—è dropdown */
    .dropdown-menu {
        padding: 0;
        border-radius: 5px;
    }
    
    .service-icon {
        margin-right: 8px;
    }
</style>

<script>
    function updateStatus(bookingId, statusId) {
        fetch(`/update_booking_status/${bookingId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}' 
            },
            body: JSON.stringify({ status_id: statusId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert("–°—Ç–∞—Ç—É—Å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!");
                location.reload();
            } else {
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞.");
            }
        })
        .catch(error => {
            console.error("–û—à–∏–±–∫–∞:", error);
        });
    }
</script>
{% endblock %}
