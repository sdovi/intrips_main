{% extends 'custom_admin/base.html' %}

{% block content %}
    {% load static %}
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{% static 'styles.css' %}">
    <style>
        #unreadMessagesCount.hidden {
            display: none;
        }
        
        
        @font-face {
            font-family: 'TT Firs Neue Regular';
            src: url('{% static "fonts/TT_Firs_Neue_Trial_Regular.ttf" %}') format('truetype');
            font-weight: normal;
            font-style: normal;
        }
        
        @font-face {
            font-family: 'TT Firs Neue DemiBold';
            src: url('{% static "fonts/TT_Firs_Neue_Trial_DemiBold.ttf" %}') format('truetype');
            font-weight: bold;
            font-style: normal;
        }
        
        * {
            font-family: 'TT Firs Neue DemiBold', sans-serif;
        }




@media (max-width: 768px) {
    /* –ß–∞—Ç-–∫–Ω–æ–ø–∫–∞ */
    .chat-toggle {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 50%;
        font-size: 18px;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        z-index: 1001;
    }

    /* –ß–∞—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç */
    .chat-box {
        position: fixed;
        bottom: 80px;
        right: 10px;
        width: 90%;
        max-width: 350px;
        background: white;
        padding: 15px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        border-radius: 10px;
        display: none;
        z-index: 1000;
    }

    /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á–∞—Ç, –∫–æ–≥–¥–∞ –∞–∫—Ç–∏–≤–µ–Ω */
    .chat-box.active {
        display: block;
    }
  
}
/* –ì—Ä–∞–¥–∏–µ–Ω—Ç—ã */
.blue { background: linear-gradient(45deg, #28a745, #a8e063); }
.purple { background: linear-gradient(45deg, #6f42c1, #b23cf7); }
.green { background: linear-gradient(45deg, #28a745, #a8e063); }

/* –ê–Ω–∏–º–∞—Ü–∏—è –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞ */
@keyframes gradientAnimation {
    0% { background-position: left; }
    100% { background-position: right; }
}


    </style>    
</head>

<body class="bg-gray-100">
    

    
 <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç - –ß–∞—Ç -->
 <div class="container mx-auto p-6">
    <div class="bg-white rounded-lg shadow p-6">
      <h1 class="text-2xl font-bold mb-4">–ß–∞—Ç —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h1>
      <button id="unanswered" class="bg-blue-500 text-white px-4 py-2 rounded">
        –ü–æ–∫–∞–∑–∞—Ç—å –Ω–µ–æ—Ç–≤–µ—á–µ–Ω–Ω—ã–µ
      </button>
      <div id="messages" class="space-y-4 mt-4">
        <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è —Å—é–¥–∞ -->
      </div>
    </div>
  </div>

  <!-- –§–æ—Ä–º–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π -->
  <div class="fixed bottom-4 right-4 bg-white p-4 shadow-lg rounded-lg w-80">
    <label for="userIdInput" class="block text-gray-700 font-bold mb-2">User ID:</label>
    <input id="userIdInput" type="text" class="w-full px-4 py-2 border rounded mb-4" placeholder="–í–≤–µ–¥–∏—Ç–µ User ID" readonly />
    <label for="messageInput" class="block text-gray-700 font-bold mb-2">–°–æ–æ–±—â–µ–Ω–∏–µ:</label>
    <textarea id="messageInput" rows="4" class="w-full px-4 py-2 border rounded mb-4" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"></textarea>
    <button id="sendMessageBtn" class="bg-blue-500 text-white px-4 py-2 rounded w-full">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
  </div>
</div>



    <script src="https://kit.fontawesome.com/5ac26fc84a.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/themes/base/jquery-ui.min.css">
    


    {% comment %} –º–µ–¥–∏—è {% endcomment %}
    <script>

        document.addEventListener("DOMContentLoaded", function () {
            const chatToggle = document.createElement("button");
            chatToggle.className = "chat-toggle";
            chatToggle.innerHTML = "üí¨";
            document.body.appendChild(chatToggle);
        
            const chatBox = document.querySelector(".fixed.bottom-4.right-4"); // –ß–∞—Ç-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            chatBox.classList.add("chat-box");
        
            chatToggle.addEventListener("click", function () {
                chatBox.classList.toggle("active");
            });
        });
        

    </script>
    <script>
        $(document).ready(function(){
            $("#date").datepicker({ dateFormat: "yy-mm-dd" });
        });
    </script>
    

     <!-- –°–∫—Ä–∏–ø—Ç –¥–ª—è —á–∞—Ç–∞ -->
  <script>
    // –ü–æ–ª—É—á–∞–µ–º shopUrl –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è shop –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–µ—Ä–µ–¥–∞–Ω–∞ –≤ —à–∞–±–ª–æ–Ω)
    const shopUrl = "{{ shop.website_url }}";
    const messagesContainer = document.getElementById('messages');
    const unansweredBtn = document.getElementById('unanswered');
    const userIdInput = document.getElementById('userIdInput');
    const messageInput = document.getElementById('messageInput');
    const sendMessageBtn = document.getElementById('sendMessageBtn');
    const unreadMessagesBadge = document.getElementById('unreadMessagesCount');
    
    let showUnanswered = false;
    let selectedMessageId = null;
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ CSRF-—Ç–æ–∫–µ–Ω–∞
    function getCSRFToken() {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith('csrftoken=')) {
          return cookie.substring('csrftoken='.length);
        }
      }
      return null;
    }
    const csrfToken = getCSRFToken();
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
    async function fetchMessages() {
      // –§–æ—Ä–º–∏—Ä—É–µ–º URL —Å —É—á–µ—Ç–æ–º –ø—Ä–µ—Ñ–∏–∫—Å–∞ "chat/"
      const url = `/chat/${shopUrl}/messages/?unanswered=${showUnanswered}`;
      console.log('Fetching messages from:', url);
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π: ${response.statusText}`);
        const messages = await response.json();
        console.log('Messages received:', messages);
        messagesContainer.innerHTML = messages.map(msg => `
          <div class="p-2 ${msg.is_admin ? 'text-right' : 'text-left'}">
            <p class="p-2 rounded ${msg.is_admin ? 'bg-blue-100' : 'bg-gray-200'}">
              <strong>${msg.is_admin ? 'Admin' : msg.user_id}</strong>: ${msg.message}
            </p>
            <small class="text-gray-500">${new Date(msg.timestamp).toLocaleString()}</small>
            ${msg.is_admin ? '' : `<button class="text-blue-500 underline reply-btn" data-id="${msg.id}" data-user="${msg.user_id}">–û—Ç–≤–µ—Ç–∏—Ç—å</button>`}
          </div>
        `).join('');
        document.querySelectorAll('.reply-btn').forEach(button => {
          button.addEventListener('click', (event) => {
            selectedMessageId = event.target.dataset.id;
            userIdInput.value = event.target.dataset.user;
            messageInput.focus();
          });
        });
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
      }
    }
  
    


// –ü–æ–ª—É—á–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç—ã
const unreadMessagesBadge = document.getElementById('unreadMessagesCount');

// –ò–∑–Ω–∞—á–∞–ª—å–Ω–æ —Å–∫—Ä—ã–≤–∞–µ–º, –µ—Å–ª–∏ —Ç–∞–º "0"
if (unreadMessagesBadge.textContent.trim() === "0") {
    unreadMessagesBadge.classList.add('hidden');
}



async function fetchUnreadCount() {
  const url = `/chat/${shopUrl}/unread_count/`;
  try {
    const response = await fetch(url);
    if (!response.ok) throw new Error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ–æ–±—â–µ–Ω–∏–π");

    const data = await response.json();
    const unreadCount = data.unread_count;

    const unreadMessagesBadge = document.getElementById("unreadMessagesCount");

    if (unreadCount > 0) {
      unreadMessagesBadge.textContent = unreadCount;
      unreadMessagesBadge.classList.remove("hidden"); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º
    } else {
      unreadMessagesBadge.classList.add("hidden"); // –ü—Ä—è—á–µ–º –µ—Å–ª–∏ 0
      unreadMessagesBadge.textContent = "";
    }
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π:", error);
  }
}


// –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
fetchUnreadCount();

// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
setInterval(fetchUnreadCount, 10000);





  
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    sendMessageBtn.addEventListener('click', async () => {
      const recipientId = userIdInput.value.trim();
      const message = messageInput.value.trim();
      if (!recipientId || !message) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è.');
        return;
      }
      const payload = {
        user_id: recipientId,
        message: message,
        is_admin: true,
        replied_to: selectedMessageId || null,
      };
      try {
        const response = await fetch(`/chat/${shopUrl}/messages/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
          },
          body: JSON.stringify(payload),
        });
        if (response.ok) {
          alert('–°–æ–æ–±—â–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
          userIdInput.value = '';
          messageInput.value = '';
          selectedMessageId = null;
          fetchMessages();
          fetchUnreadCount();
        } else {
          const error = await response.json();
          alert(`–û—à–∏–±–∫–∞: ${error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ.'}`);
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
      }
    });
    
    // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ —Å—á—ë—Ç—á–∏–∫–∞
    setInterval(() => {
      fetchMessages();
      fetchUnreadCount();
    }, 10000);
    
    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫—É "–ü–æ–∫–∞–∑–∞—Ç—å –Ω–µ–æ—Ç–≤–µ—á–µ–Ω–Ω—ã–µ / –ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—á–µ–Ω–Ω—ã–µ"
    unansweredBtn.addEventListener('click', () => {
        showUnanswered = !showUnanswered; // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        fetchMessages(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
    
        // –ú–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è
        unansweredBtn.textContent = showUnanswered ? "–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—á–µ–Ω–Ω—ã–µ" : "–ü–æ–∫–∞–∑–∞—Ç—å –Ω–µ–æ—Ç–≤–µ—á–µ–Ω–Ω—ã–µ";
    });
  
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
    fetchMessages();
    fetchUnreadCount();
  </script>
</body>

{% endblock %}
