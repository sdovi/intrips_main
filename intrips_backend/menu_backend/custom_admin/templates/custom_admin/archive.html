{% extends 'custom_admin/base.html' %}
{% block content %}
<style>

    .badge{
        display: block !important;
    }
</style>
<h2>üìÇ –ê—Ä—Ö–∏–≤ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π: {{ shop.name }}</h2>

<a href="{% url 'bookings_list' shop.website_url %}" class="btn btn-primary mb-3">üîô –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è–º</a>

<!-- –¢–∞–±–ª–∏—Ü–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–π -->
<table class="table custom-table">
    <thead class="table-dark">
        <tr>
            <th>–£—Å–ª—É–≥–∞</th>
            <th>–ö–æ–º–Ω–∞—Ç–∞</th>
            <th>–ì–æ—Å—Ç–∏</th>
            <th>–î–∞—Ç–∞</th>
            <th>–í—Ä–µ–º—è</th>
            <th>–°–æ—Ç—Ä—É–¥–Ω–∏–∫</th>
            <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–û–±—â–∞—è —Å—É–º–º–∞</th>  
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
    </thead>
    <tbody>
        {% for booking in bookings %}
        <tr class="table-row">
            <td class="service-column">
                <img src="/static/img/logo_gotovo.png" alt="Service Icon" class="service-icon">
                {{ booking.service_name }}
            </td>
            <td>{{ booking.room_number }}</td>
            <td>{{ booking.guest_count }}</td>
            <td>{{ booking.date }}</td>
            <td>{{ booking.start_time }} - {{ booking.end_time|default:"--:--" }}</td>
            <td>{{ booking.employee.full_name }}</td>
            <td>{{ booking.comment|default:"-" }}</td>
            <td>
                <span class="badge 
                    {% if booking.status.name == '–í—ã–ø–æ–ª–Ω–µ–Ω–æ' %}bg-success
                    {% elif booking.status.name == '–û—Ç–º–µ–Ω–µ–Ω' %}bg-danger
                    {% else %}bg-secondary
                    {% endif %}">
                    {{ booking.status.name }}
                </span>
            </td>
            <td class="text-end"><strong>{{ booking.total_price }} ‚ÇΩ</strong></td>
            <td>
                <div class="dropdown">
                    <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        –ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å
                    </button>
                    <ul class="dropdown-menu">
                        {% for status in statuses %}
                        <li>
                            <a class="dropdown-item" href="#" onclick="updateStatus({{ booking.id }}, {{ status.id }}, '{{ shop.website_url }}')">
                                {{ status.name }}
                            </a>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="10" class="text-center">üì≠ –ê—Ä—Ö–∏–≤ –ø—É—Å—Ç</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ -->
<style>
    table {
        width: 100%;
        border-collapse: collapse;
    }

    th, td {
        padding: 14px 18px;
        text-align: left;
    }

    /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è –∏–∫–æ–Ω–∫–∏ –∏ —Ç–µ–∫—Å—Ç–∞ —É—Å–ª—É–≥–∏ */
    .service-column {
        display: flex;
        align-items: center;
    }

    .service-icon {
        margin-right: 8px;
    }

    /* Dropdown –º–µ–Ω—é —Å—Ç–∏–ª–∏ */
    .dropdown-menu {
        padding: 0;
        border-radius: 5px;
    }
</style>

<script>
    function updateStatus(bookingId, statusId, shopUrl) {
        fetch(`/${shopUrl}/update_booking_status/${bookingId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ status_id: statusId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`–°—Ç–∞—Ç—É—Å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω –Ω–∞: ${data.status}`);
                location.reload();
            } else {
                alert(`–û—à–∏–±–∫–∞: ${data.error}`);
            }
        })
        .catch(error => {
            console.error("–û—à–∏–±–∫–∞:", error);
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞.");
        });
    }
</script>

{% endblock %}
